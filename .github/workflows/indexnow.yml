name: IndexNow Submit

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  indexnow:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install Dependencies
        run: npm ci

      # 1. 关键步骤：执行构建，这会生成包含所有正确动态链接的 public/sitemap.xml
      - name: Build & Generate Sitemap
        run: npm run build
        env:
          # 如果你的构建需要 API Key 等环境变量，可以在这里或者 GitHub Secrets 添加
          NEXT_PUBLIC_SITE_URL: https://www.bestgbagames.com

      # 2. Python 脚本：直接读取 sitemap.xml 里的链接进行提交
      - name: Submit URLs from Sitemap
        env:
          INDEXNOW_KEY: "cb5ad8431a4a499d9048348786f972eb"
          DOMAIN: "https://www.bestgbagames.com"
        run: |
          python3 - <<'PY'
          import os
          import requests
          import xml.etree.ElementTree as ET
          
          domain = os.environ['DOMAIN']
          key = os.environ['INDEXNOW_KEY']
          host = domain.replace('https://', '').replace('http://', '').strip('/')
          
          sitemap_path = 'public/sitemap.xml'
          # next-sitemap 有时生成的是索引 sitemap-0.xml
          if not os.path.exists(sitemap_path) and os.path.exists('public/sitemap-0.xml'):
              sitemap_path = 'public/sitemap-0.xml'

          try:
              tree = ET.parse(sitemap_path)
              root = tree.getroot()
              # 提取所有 <loc> 标签的内容，命名空间处理
              urls = []
              for child in root:
                  for subchild in child:
                      if subchild.tag.endswith('loc'):
                          urls.append(subchild.text)
              
              print(f"Found {len(urls)} URLs in sitemap.")
              
              if not urls:
                  print("No URLs found, skipping.")
                  exit(0)

              # 构造 IndexNow 请求
              payload = {
                  "host": host,
                  "key": key,
                  "keyLocation": f"{domain}/{key}.txt",
                  "urlList": urls
              }
              
              print("Submitting to IndexNow...")
              response = requests.post(
                  'https://api.indexnow.org/indexnow',
                  json=payload,
                  headers={'Content-Type': 'application/json; charset=utf-8'}
              )
              
              if response.status_code in [200, 202]:
                  print("✅ Success! IndexNow received the URLs.")
              else:
                  print(f"❌ Failed: {response.status_code} - {response.text}")
                  exit(1)

          except Exception as e:
              print(f"❌ Error: {e}")
              exit(1)
          PY